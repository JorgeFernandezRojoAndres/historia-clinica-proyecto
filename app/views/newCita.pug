extends layout

block content
  h2 Nueva Cita

  form(action="/citas/new" method="POST")
    //- Selector de Especialidades
    label(for="especialidadSelector") Especialidad:
    select(name="especialidadSelector" id="especialidadSelector")
      option(value="") -- Selecciona una especialidad --
      each especialidad in especialidades
        option(value=especialidad.idEspecialidad) #{especialidad.nombre} 
    br

    //- Selector de Médicos
    label(for="idMedico") Médico:
    select(name="idMedico" id="idMedico" required)
      option(value="") -- Selecciona un médico --
      each medico in medicos
        option(value=medico.idMedico) #{medico.nombre} 
    br

    label(for="especialidadMedico") Especialidad del Médico:
    input(type="text" id="especialidadMedico" readonly)
    br

    label(for="buscarPaciente") Buscar Paciente:
    if nombrePaciente
      input(type="text" id="buscarPaciente" name="nombrePaciente" value=nombrePaciente readonly)
      input(type="hidden" name="idPaciente" value=idPaciente)
    else
      input(type="text" id="buscarPaciente" placeholder="Ingresa nombre o DNI" autocomplete="off" required)
      input(type="hidden" name="idPaciente" id="idPaciente")

    ul#listaResultados(style="border: 1px solid #ddd; padding: 5px; max-height: 150px; overflow-y: auto; position: absolute; background: white; width: 200px; z-index: 1000; display: none;")

    a#verAgendaButton.btn.btn-primary(href="#" target="_blank") Ver Agenda del Médico

    label(for="fechaHora") Fecha y Hora:
    input(type="datetime-local" name="fechaHora" id="fechaHora" required)
    br

    label(for="motivoConsulta") Motivo de Consulta:
    input(type="text" name="motivoConsulta" required)
    br

    label(for="tipoTurno") Tipo de Turno:
    select(name="tipoTurno" id="tipoTurno" required)
      option(value="regular") Regular
      option(value="sobreturno") Sobreturno
    br

    button(type="submit") Crear Cita

block scripts
  script(src="/selectorMedico.js")
  script.
    document.addEventListener('DOMContentLoaded', function() {
      const especialidadSelector = document.getElementById('especialidadSelector');
      const medicoSelector = document.getElementById('idMedico');
      const verAgendaButton = document.getElementById('verAgendaButton');
      const medicos = !{JSON.stringify(medicos)}; // Aquí pasamos los médicos al script
      const buscarPacienteInput = document.getElementById('buscarPaciente');
      const listaResultados = document.getElementById('listaResultados');

      // Filtrado de médicos por especialidad
      especialidadSelector.addEventListener('change', function() {
        const especialidadSeleccionada = this.value;
        medicoSelector.innerHTML = '<option value="">-- Selecciona un médico --</option>';
        
        medicos.forEach(medico => {
          if (medico.especialidad === especialidadSeleccionada) {
            const option = document.createElement('option');
            option.value = medico.idMedico;
            option.textContent = medico.nombre;
            option.setAttribute('data-especialidad', medico.especialidad);
            medicoSelector.appendChild(option);
          }
        });
      });

      medicoSelector.addEventListener('change', function() {
        const medicoSeleccionado = this.options[this.selectedIndex];
        const medicoId = medicoSeleccionado.value;

        document.getElementById('especialidadMedico').value = medicoSeleccionado.getAttribute('data-especialidad') || '';

        if (medicoId) {
          verAgendaButton.href = `/medicos/${medicoId}/agenda`;
          verAgendaButton.style.display = 'inline-block';
        } else {
          verAgendaButton.style.display = 'none';
        }
      });

      buscarPacienteInput.addEventListener('input', async function() {
        const query = buscarPacienteInput.value.trim();
        if (query.length > 0) {
          try {
            const response = await fetch(`/citas/buscar-paciente?term=${query}`);
            const pacientes = await response.json();
            mostrarResultados(pacientes);
          } catch (error) {
            console.error('Error al buscar pacientes:', error);
          }
        } else {
          listaResultados.style.display = 'none';
        }
      });

      function mostrarResultados(pacientes) {
        listaResultados.innerHTML = '';
        if (pacientes.length > 0) {
          listaResultados.style.display = 'block';
          pacientes.forEach(paciente => {
            const li = document.createElement('li');
            li.textContent = `${paciente.nombre} (ID: ${paciente.idPaciente})`;
            li.style.cursor = 'pointer';
            li.addEventListener('click', () => seleccionarPaciente(paciente));
            listaResultados.appendChild(li);
          });
        } else {
          listaResultados.style.display = 'none';
        }
      }

      function seleccionarPaciente(paciente) {
        buscarPacienteInput.value = paciente.nombre;
        listaResultados.style.display = 'none';
        document.getElementById('idPaciente').value = paciente.idPaciente;
      }

      document.addEventListener('click', function(e) {
        if (!buscarPacienteInput.contains(e.target) && !listaResultados.contains(e.target)) {
          listaResultados.style.display = 'none';
        }
      });
    });
