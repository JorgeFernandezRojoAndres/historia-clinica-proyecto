doctype html
html
  head
    title Agenda del Médico
    link(rel="stylesheet" href="/css/style.css")
  body
    h1 Agenda del Médico

    // Mostrar el selector de fecha solo si no es la agenda del día
    if !agendaDelDia
      div#fechaSelector
        label(for="fecha") Seleccionar Fecha:
        input(type="date" id="fecha" name="fecha" value=fechaHoy onchange="cambiarFecha()")

    h2 Turnos Regulares
    div#citasContainer
      if regulares && regulares.length > 0
        table
          thead
            tr
              th Fecha y Hora
              th Paciente
              th Motivo de Consulta
          tbody
            each cita in regulares
              tr
                td= cita.fechaHora
                td= cita.nombrePaciente || 'Paciente no disponible'
                td= cita.motivoConsulta || 'Motivo no disponible'
      else
        p No hay turnos regulares disponibles para este médico.

    h2 Sobreturnos
    div#sobreturnosContainer
      if sobreturnos && sobreturnos.length > 0
        table
          thead
            tr
              th Fecha y Hora
              th Paciente
              th Motivo de Consulta
          tbody
            each cita in sobreturnos
              tr
                td= cita.fechaHora
                td= cita.nombrePaciente || 'Paciente no disponible'
                td= cita.motivoConsulta || 'Motivo no disponible'
      else
        p No hay sobreturnos disponibles para este médico.

    if horariosLibres && horariosLibres.length > 0 && user.role !== 'Medico'
      h2 Horarios Libres
      table
        thead
          tr
            th Horario Libre
        tbody
          each hora in horariosLibres
            - var ocupado = regulares.concat(sobreturnos).some(cita => cita.fechaHora.includes(hora))
            if !ocupado
              tr
                td= `${fechaHoy} ${hora}`
                td
                  button.btn-seleccionar(onclick=`seleccionarHorario('${fechaHoy}', '${hora}')`) Seleccionar
    else
      p No hay horarios libres disponibles.

    script.
      // Esta es una función para seleccionar el horario
      function seleccionarHorario(fecha, hora) {
        const fechaHora = `${fecha}T${hora}:00`;

        console.log("Fecha y hora seleccionada:", fechaHora); // Verifica que la fecha y hora son correctas

        if (window.opener && !window.opener.closed) {
          const fechaHoraInput = window.opener.document.getElementById('fechaHora');
          if (fechaHoraInput) {
            // Si el campo existe, actualiza su valor
            fechaHoraInput.value = fechaHora;
          } else {
            // Si no se encuentra el campo, mostrar alerta
            alert("No se encontró el campo de fecha y hora en la ventana principal.");
          }
        } else {
          // Si la ventana principal no está disponible, se almacena en sessionStorage
          alert("La ventana principal no está disponible. Guardando en sessionStorage.");
          sessionStorage.setItem('fechaHoraSeleccionada', fechaHora);
        }

        // Cerrar la ventana secundaria
        window.close();
      }

  script(src="/selectorMedico.js")
