const db = require('../../config/database');
const bcrypt = require('bcryptjs');

exports.showLoginForm = (req, res) => {
    res.render('login', { user: req.session.user });  // Mostrar√° el formulario de login
};

exports.loginPaciente = async (req, res) => {
    console.log(req.body); // Verificar que los datos se reciban correctamente
    const { dni } = req.body;

    // Buscar paciente en la base de datos
    const sql = 'SELECT * FROM pacientes WHERE dni = ?';
    db.query(sql, [dni], (error, results) => {
        if (error) {
            console.error('Error al buscar paciente:', error); // Impresi√≥n del error
            return res.status(500).send('Error al buscar paciente');
        }

        console.log('Resultados de la b√∫squeda:', results); // Mostrar resultados de la b√∫squeda

        if (results.length > 0) {
            // Iniciar sesi√≥n: Establecer una sesi√≥n para el paciente
            req.session.user = {
                id: results[0].idPaciente,
                nombre: results[0].nombre,
                role: 'paciente'
            };

            // ‚úÖ Guardar la sesi√≥n antes de redirigir
            return req.session.save((err) => {
                if (err) {
                    console.error("Error guardando sesi√≥n:", err);
                    return res.status(500).send("Error al guardar sesi√≥n");
                }
                // Redirigir al formulario de selecci√≥n de cl√≠nica
                return res.redirect('/select-clinica'); 
            });
        } else {
            // Manejar el caso donde el paciente no se encuentra
            return res.status(401).send('Paciente no encontrado');
        }
    });
};


// Funci√≥n de inicio de sesi√≥n para usuarios con el rol de secretaria.


exports.loginSecretaria = (req, res) => {
    const { username, password } = req.body;

    const sql = 'SELECT * FROM usuarios WHERE username = ?';
    db.query(sql, [username], (error, results) => {
        if (error) {
            return res.status(500).render('loginsecretarias', { message: 'Ocurri√≥ un error en el servidor' });
        }

        if (results.length === 0 || !bcrypt.compareSync(password, results[0].password)) {
            return res.status(401).render('loginsecretarias', { message: 'Credenciales incorrectas' });
        }

        // Guarda los datos del usuario en la sesi√≥n
        req.session.user = {
            id: results[0].id,
            username: results[0].username,
            role: results[0].role
        };

        // üîπ Si es secretaria ‚Üí acceso a ambas cl√≠nicas
        if (req.session.user.role === 'secretaria') {
            req.session.idClinica = [1, 2]; // ahora ve todas

            // ‚úÖ Guardar sesi√≥n antes de redirigir
            return req.session.save((err) => {
                if (err) {
                    console.error("Error guardando sesi√≥n:", err);
                    return res.status(500).send("Error al guardar sesi√≥n");
                }
                return res.redirect('/secretaria/pacientes');
            });
        }

        // üîπ Si fuera admin u otro rol
        if (req.session.user.role === 'administrador') {
            return req.session.save((err) => {
                if (err) {
                    console.error("Error guardando sesi√≥n:", err);
                    return res.status(500).send("Error al guardar sesi√≥n");
                }
                return res.redirect('/admin/dashboard');
            });
        } else {
            return res.status(403).send('Acceso denegado');
        }
    });
};


// Funci√≥n de inicio de sesi√≥n para el administrador
exports.loginAdministrador = (req, res) => {
    const { username, password } = req.body;

    console.log('Intento de inicio de sesi√≥n para administrador:', username);

    const sql = 'SELECT * FROM usuarios WHERE username = ? AND role = "administrador"';
    db.query(sql, [username], (error, results) => {
        if (error) {
            console.error('Error en la consulta:', error);
            return res.status(500).render('loginadministrador', { message: 'Ocurri√≥ un error en el servidor' });
        }

        if (results.length === 0) {
            console.log('Administrador no encontrado o credenciales incorrectas');
            return res.status(401).render('loginadministrador', { message: 'Credenciales incorrectas' });
        }

        const user = results[0];
        console.log('Usuario encontrado:', user);

        // Comparar la contrase√±a ingresada con el hash en la base de datos
        if (!bcrypt.compareSync(password, user.password)) {
            console.log('Contrase√±a incorrecta para el administrador');
            return res.status(401).render('loginadministrador', { message: 'Credenciales incorrectas' });
        }

        // Si la autenticaci√≥n es exitosa, guardar los datos en la sesi√≥n
        req.session.user = {
            id: user.id,
            username: user.username,
            role: user.role
        };

        console.log('Sesi√≥n guardada para el administrador:', req.session.user);

        // Redirigir al panel de administraci√≥n
        res.redirect('/admin/dashboard');
    });
};


exports.loginMedico = (req, res) => {
    console.log("Inicio del proceso de login");
    console.log("Datos ingresados:", req.body);

    const { username, password } = req.body;
    const sqlMedico = 'SELECT * FROM medicos WHERE nombre = ?';

    db.query(sqlMedico, [username], (error, results) => {
        if (error || results.length === 0) {
            console.error('Error o credenciales incorrectas:', error || "No se encontr√≥ el m√©dico.");
            return res.status(401).render('loginmedicos', { message: 'Credenciales incorrectas' });
        }

        const user = results[0];
        console.log("Usuario encontrado:", user);

        // Verifica si el DNI coincide con la contrase√±a ingresada
        if (password === user.dni) {
            // üîπ Guardamos usuario en sesi√≥n
            req.session.user = { 
                id: user.idMedico, 
                role: 'medico',   // ahora siempre en min√∫scula
                nombre: user.nombre 
            };

            console.log("Sesi√≥n guardada provisional:", req.session.user);

            // === Nueva l√≥gica: cargar cl√≠nica asociada ===
            const sqlClinicas = 'SELECT idClinica FROM medicos_clinicas WHERE idMedico = ?';
            db.query(sqlClinicas, [user.idMedico], (errorClinicas, clinicas) => {
                if (errorClinicas) {
                    console.error('Error al obtener cl√≠nicas del m√©dico:', errorClinicas);
                    return res.status(500).render('loginmedicos', { message: 'Error al verificar cl√≠nicas' });
                }

                if (clinicas.length > 0) {
                    // Tomar la primera cl√≠nica asociada autom√°ticamente
                    req.session.idClinica = clinicas[0].idClinica;
                    req.session.clinicaSeleccionada = true;

                    console.log(`Cl√≠nica autom√°ticamente seleccionada: ${clinicas[0].idClinica}`);

                    // ‚úÖ Guardar la sesi√≥n antes de redirigir
                    return req.session.save(err => {
                        if (err) {
                            console.error("Error guardando sesi√≥n:", err);
                            return res.status(500).send("Error al guardar sesi√≥n");
                        }
                        return res.redirect('/medicos/perfil');
                    });

                } else {
                    return res.render('loginmedicos', { message: 'No hay cl√≠nicas asociadas a su cuenta' });
                }
            });

        } else {
            console.error('Contrase√±a incorrecta');
            return res.status(401).render('loginmedicos', { message: 'Credenciales incorrectas' });
        }
    });
};


exports.cambiarContrasena = (req, res) => {
    const newPassword = req.body.newPassword;
    const userId = req.session.user.id;

    console.log('ID del m√©dico:', userId);

    // Actualiza la contrase√±a en la tabla usuarios
    const sqlUpdatePassword = 'UPDATE usuarios SET password = ? WHERE id = ?';
    db.query(sqlUpdatePassword, [bcrypt.hashSync(newPassword, 10), userId], (error) => {
        if (error) {
            console.error('Error al cambiar la contrase√±a:', error);
            return res.status(500).send('Error al cambiar la contrase√±a');
        }

        // Actualiza el flag de password_change_required en la tabla medicos
        const sqlUpdateMedicos = 'UPDATE medicos SET password_change_required = ? WHERE idMedico = ?';
        db.query(sqlUpdateMedicos, [0, userId], (error) => {
            if (error) {
                return res.status(500).send('Error al actualizar el m√©dico');
            }
            res.redirect('/medico/escritorio'); // Redirige despu√©s de cambiar la contrase√±a
        });
    });
};

exports.seleccionarClinica = (req, res) => {
    console.log('Datos enviados desde el formulario:', req.body);
    console.log('Sesi√≥n antes de guardar cl√≠nica:', req.session);

    try {
        const { idClinica } = req.body;

        if (!idClinica) {
            console.error('Error: No se recibi√≥ idClinica en la solicitud.');
            return res.status(400).send('Debe seleccionar una cl√≠nica.');
        }

        req.session.idClinica = idClinica;
        req.session.clinicaSeleccionada = true; // Establecer el flag de cl√≠nica seleccionada

        console.log(`Cl√≠nica seleccionada: ${idClinica}`);
        console.log('Sesi√≥n despu√©s de la selecci√≥n:', req.session);

        // Redirigir seg√∫n el rol
        if (req.session.user) {
            switch (req.session.user.role) {
                case 'paciente':
                    console.log('Redirigiendo al perfil del paciente...');
                    return res.redirect('/paciente/mi-perfil');
                case 'secretaria':
                    console.log('Redirigiendo a la p√°gina de pacientes de la secretaria...');
                    return res.redirect('/secretaria/pacientes');
                case 'administrador':
                    console.log('Redirigiendo al panel del administrador...');
                    return res.redirect('/admin/dashboard');
                default:
                    console.warn('Rol desconocido, redirigiendo al inicio...');
                    return res.redirect('/');
            }
        } else {
            // Si no hay usuario en sesi√≥n, redirigir al login
            console.warn('Sesi√≥n de usuario no encontrada, redirigiendo al login...');
            return res.redirect('/login');
        }
    } catch (error) {
        console.error('Error en seleccionarClinica:', error);
        return res.status(500).send('Ocurri√≥ un error al procesar la solicitud.');
    }
};



exports.logout = (req, res) => {
    req.session.destroy(err => {
        if (err) {
            console.error('Error al destruir sesi√≥n:', err);
        }
        res.clearCookie('turnoexpress.sid'); // üîπ Borra la cookie en el navegador
        res.redirect('/');
    });
};
